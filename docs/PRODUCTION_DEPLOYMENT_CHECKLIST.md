# 本番環境デプロイチェックリスト

このチェックリストは、sage-base.comドメインでSagebaseを本番環境にデプロイする際の
確認項目をまとめたものです。

**Issue**: #726 - [PBI-007] カスタムドメインの設定と本番環境への公開

---

## 📋 デプロイ前の準備

### ドメイン・DNS設定
- [ ] Cloudflareでsage-base.comドメインを購入済み
- [ ] Cloudflare DNSでCNAMEまたはAレコードを設定
- [ ] wwwサブドメインのリダイレクト設定（オプション）
- [ ] DNS伝播の確認（`nslookup sage-base.com`）
- [ ] Cloudflare Proxyが有効化されている（オレンジ色のアイコン）

### Streamlit Cloud設定
- [ ] Streamlit Cloudにアプリがデプロイ済み
- [ ] カスタムドメイン（sage-base.com）を追加
- [ ] SSL証明書のステータスが **Active** になっている
- [ ] 環境変数（Secrets）を本番環境用に更新
  - [ ] `GOOGLE_OAUTH_REDIRECT_URI=https://sage-base.com/`
  - [ ] `GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX`
  - [ ] `ENVIRONMENT=production`
  - [ ] `DEBUG=false`

### Google Analytics設定
- [ ] Google Analytics 4プロパティを作成
- [ ] データストリーム（Web）を追加（URL: https://sage-base.com）
- [ ] 測定ID（G-XXXXXXXXXX）をコピー
- [ ] Streamlit Cloud Secretsに `GOOGLE_ANALYTICS_ID` を設定

---

## 🔒 セキュリティ設定

### Cloudflare Workers
- [ ] セキュリティヘッダー用のWorkerを作成
- [ ] Workerスクリプトをデプロイ
- [ ] `sage-base.com/*` にルートを追加
- [ ] 以下のヘッダーが設定されているか確認：
  - [ ] `X-Frame-Options: DENY`
  - [ ] `X-Content-Type-Options: nosniff`
  - [ ] `Strict-Transport-Security`
  - [ ] `Content-Security-Policy`
  - [ ] `Referrer-Policy`

### SSL/TLS設定
- [ ] SSL証明書が有効（Let's Encrypt）
- [ ] HTTPSアクセスが正常に動作
- [ ] HTTPからHTTPSへの自動リダイレクトが動作
- [ ] 証明書の有効期限が十分に長い（自動更新される）

### 認証設定
- [ ] Google OAuthクライアントIDとシークレットが設定済み
- [ ] リダイレクトURIに `https://sage-base.com/` が登録済み
- [ ] 許可されたメールアドレスリストが設定済み（必要に応じて）
- [ ] OAuth認証フローが本番ドメインで動作

---

## 🔍 SEO・アクセシビリティ設定

### robots.txtとsitemap.xml
- [ ] `robots.txt` がプロジェクトルートに存在
- [ ] `sitemap.xml` がプロジェクトルートに存在
- [ ] https://sage-base.com/robots.txt にアクセス可能
- [ ] https://sage-base.com/sitemap.xml にアクセス可能
- [ ] robots.txtに正しいサイトマップURLが記載されている

### Google Search Console
- [ ] Google Search Consoleにプロパティを追加
- [ ] DNSベースの所有権確認を完了
- [ ] サイトマップ（https://sage-base.com/sitemap.xml）を送信
- [ ] インデックス登録のリクエストを送信（初回のみ）

### メタタグ・OGP設定
- [ ] ページタイトルが適切に設定されている
- [ ] ページアイコン（favicon）が設定されている
- [ ] 404エラーページが実装されている

---

## ✅ 機能テスト

### 基本動作確認
- [ ] https://sage-base.com/ (ホームページ) にアクセス可能
- [ ] ログインページが表示される（OAuth無効時はスキップ）
- [ ] Google OAuthでログインできる
- [ ] ログアウトが正常に動作
- [ ] すべてのナビゲーションリンクが動作

### 各ページの動作確認
- [ ] 会議管理ページ（/meetings）が正常に動作
- [ ] 政党管理ページ（/political_parties）が正常に動作
- [ ] 会議体管理ページ（/conferences）が正常に動作
- [ ] 開催主体管理ページ（/governing_bodies）が正常に動作
- [ ] 政治家管理ページ（/politicians）が正常に動作
- [ ] 政治家レビューページ（/extracted_politicians）が正常に動作
- [ ] 議員団管理ページ（/parliamentary_groups）が正常に動作
- [ ] 議案管理ページ（/proposals）が正常に動作
- [ ] 発言レコードページ（/conversations）が正常に動作
- [ ] 発言・発言者管理ページ（/conversations_speakers）が正常に動作
- [ ] 処理実行ページ（/processes）が正常に動作
- [ ] LLM履歴ページ（/llm_history）が正常に動作
- [ ] 作業履歴ページ（/work_history）が正常に動作

### データ操作確認
- [ ] データの閲覧が正常に動作
- [ ] データの検索・フィルタリングが正常に動作
- [ ] データの編集が正常に動作（権限がある場合）
- [ ] データの削除が正常に動作（権限がある場合）
- [ ] ファイルアップロードが正常に動作

### 処理実行確認
- [ ] 議事録処理が正常に実行される
- [ ] 政治家スクレイピングが正常に実行される
- [ ] LLM処理が正常に動作
- [ ] エラーハンドリングが適切に動作
- [ ] 処理履歴が正しく記録される

---

## 📊 モニタリング・分析

### Google Analytics
- [ ] ページビューがトラッキングされている
- [ ] リアルタイムレポートでアクセスが確認できる
- [ ] イベントトラッキングが動作している（必要に応じて）
- [ ] コンバージョン設定が完了している（必要に応じて）

### エラー監視
- [ ] Sentry（またはその他のエラートラッキング）が設定済み
- [ ] エラーが正しく記録される
- [ ] アラート通知が設定されている
- [ ] エラーレートが許容範囲内

### パフォーマンス
- [ ] ページ読み込み時間が3秒以内
- [ ] 大量データの表示が適切にページネーションされている
- [ ] データベースクエリが最適化されている
- [ ] 画像・静的ファイルが最適化されている

---

## 🌐 ブラウザ互換性テスト

### デスクトップブラウザ
- [ ] Chrome (最新版)
- [ ] Firefox (最新版)
- [ ] Safari (最新版)
- [ ] Edge (最新版)

### モバイルブラウザ
- [ ] iOS Safari
- [ ] Android Chrome
- [ ] レスポンシブデザインが正常に動作

### アクセシビリティ
- [ ] キーボードナビゲーションが動作
- [ ] スクリーンリーダー対応（基本的なARIA属性）
- [ ] カラーコントラストが適切

---

## 🔧 インフラ・バックアップ

### データベース
- [ ] 本番環境用のデータベースが設定されている
- [ ] データベース接続が安定している
- [ ] バックアップが定期的に取得されている
- [ ] リストア手順が文書化されている

### 環境変数
- [ ] すべての必須環境変数が設定されている
- [ ] APIキーが正しく設定されている
- [ ] 機密情報がGitにコミットされていない
- [ ] `.env.example` が最新の状態

---

## 📝 ドキュメント

### 更新が必要なドキュメント
- [ ] README.mdに本番環境URLを追加
- [ ] DEPLOYMENT.mdを更新
- [ ] CUSTOM_DOMAIN_SETUP.mdを確認
- [ ] API ドキュメントを更新（該当する場合）

### 手順書の整備
- [ ] デプロイ手順が文書化されている
- [ ] ロールバック手順が文書化されている
- [ ] トラブルシューティングガイドが用意されている
- [ ] 運用マニュアルが整備されている

---

## 🚀 デプロイ実行

### デプロイ前の最終確認
- [ ] すべての変更がGitにコミット・プッシュされている
- [ ] CIパイプラインがすべてパスしている
- [ ] ステージング環境でテスト済み（該当する場合）
- [ ] チーム全体に本番デプロイを通知

### デプロイ実施
- [ ] Streamlit Cloudでアプリを再デプロイ
- [ ] デプロイログにエラーがないか確認
- [ ] アプリケーションが正常に起動
- [ ] ヘルスチェックエンドポイントが正常

### デプロイ後の確認
- [ ] 本番環境でスモークテストを実施
- [ ] 主要機能が正常に動作することを確認
- [ ] エラーログを監視
- [ ] パフォーマンスメトリクスを確認

---

## 🎉 本番公開後

### 公開アナウンス
- [ ] チーム全体に本番公開を通知
- [ ] ユーザーに新しいURLを通知
- [ ] ソーシャルメディアで告知（該当する場合）
- [ ] プレスリリース（該当する場合）

### 監視体制
- [ ] 24時間以内は定期的にエラーログを確認
- [ ] ユーザーフィードバックを収集
- [ ] パフォーマンスメトリクスを継続的に監視
- [ ] インシデント対応体制を整備

### フォローアップ
- [ ] 1週間後にパフォーマンスレビューを実施
- [ ] ユーザーフィードバックを分析
- [ ] 改善点をバックログに追加
- [ ] 次のリリース計画を作成

---

## 🆘 ロールバック手順

何か問題が発生した場合のロールバック手順：

1. Streamlit Cloudでアプリを一時停止
2. 環境変数を以前の設定に戻す
3. 必要に応じてDNS設定を一時的に変更
4. 問題を修正
5. ステージング環境で再テスト
6. 再デプロイ

**緊急連絡先**:
- チームリーダー: [連絡先]
- インフラ担当: [連絡先]
- Streamlit Cloud サポート: https://docs.streamlit.io/streamlit-community-cloud/get-help

---

## ✅ 完了確認

すべてのチェック項目が完了したら、以下を実行：

1. [ ] Issue #726を更新（完了した項目をチェック）
2. [ ] スクリーンショットを添付（主要ページの動作確認）
3. [ ] セキュリティヘッダーのテスト結果を添付
4. [ ] Google Analytics のスクリーンショットを添付
5. [ ] Issue #726をクローズ 🎉

**おめでとうございます！Sagebaseが本番環境で公開されました！** 🚀
