name: Export to BigQuery

on:
  schedule:
    # ÊØéÊó• AM 6:00 JST (21:00 UTC ÂâçÊó•)
    - cron: "0 21 * * *"
  workflow_dispatch:
    inputs:
      table:
        description: "„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„ÉÜ„Éº„Éñ„É´ÂêçÔºàÁ©∫Ê¨Ñ„ÅßÂÖ®„ÉÜ„Éº„Éñ„É´Ôºâ"
        required: false
        default: ""
        type: string
      dataset:
        description: "BigQuery„Éá„Éº„Çø„Çª„ÉÉ„ÉàIDÔºàÁ©∫Ê¨Ñ„Åß„Éá„Éï„Ç©„É´„ÉàÔºâ"
        required: false
        default: ""
        type: string

permissions:
  contents: read
  id-token: write # Workload Identity FederationÁî®

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION != '' && secrets.GCP_REGION || 'asia-northeast1' }}

jobs:
  export:
    name: Export Gold Layer to BigQuery
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Google CloudË™çË®ºÔºàWorkload Identity FederationÔºâ
      - name: Authenticate to Google Cloud (Workload Identity)
        if: vars.USE_WORKLOAD_IDENTITY == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Google CloudË™çË®ºÔºàService Account KeyÔºâ
      - name: Authenticate to Google Cloud (Service Account Key)
        if: vars.USE_WORKLOAD_IDENTITY != 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Cloud SDK„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Cloud SQL Auth ProxyËµ∑Âãï
      - name: Start Cloud SQL Auth Proxy
        run: |
          # Cloud SQL Auth Proxy„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.14.3/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy

          # „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßËµ∑ÂãïÔºàTCP„É¢„Éº„Éâ: localhost:5432Ôºâ
          ./cloud-sql-proxy \
            --port 5432 \
            "${{ secrets.CLOUD_SQL_INSTANCE }}" &

          # Êé•Á∂öÂæÖÊ©ü
          for i in {1..30}; do
            if nc -z localhost 5432 2>/dev/null; then
              echo "Cloud SQL Auth Proxy is ready"
              break
            fi
            echo "Waiting for Cloud SQL Auth Proxy... ($i/30)"
            sleep 2
          done

      # Python/UV„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up UV
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      # BQ„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆüË°å
      - name: Export to BigQuery
        id: export
        env:
          DB_HOST: localhost
          DB_PORT: "5432"
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          GOOGLE_CLOUD_PROJECT: ${{ env.PROJECT_ID }}
        run: |
          START_TIME=$(date +%s)

          # „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç≥„Éû„É≥„Éâ„ÅÆÁµÑ„ÅøÁ´ã„Å¶
          EXPORT_CMD="uv run sagebase export-to-bq"

          # workflow_dispatchÊôÇ„ÅÆ„Éë„É©„É°„Éº„ÇøÂØæÂøú
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "${{ inputs.table }}" ]; then
              EXPORT_CMD="${EXPORT_CMD} --table ${{ inputs.table }}"
            else
              EXPORT_CMD="${EXPORT_CMD} --all"
            fi
            if [ -n "${{ inputs.dataset }}" ]; then
              EXPORT_CMD="${EXPORT_CMD} --dataset ${{ inputs.dataset }}"
            fi
          else
            # „Çπ„Ç±„Ç∏„É•„Éº„É´ÂÆüË°åÊôÇ„ÅØÂÖ®„ÉÜ„Éº„Éñ„É´
            EXPORT_CMD="${EXPORT_CMD} --all"
          fi

          echo "Executing: ${EXPORT_CMD}"
          ${EXPORT_CMD} 2>&1 | tee /tmp/export_output.txt
          EXIT_CODE=${PIPESTATUS[0]}

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT

          exit ${EXIT_CODE}

      # ÁµêÊûú„Çµ„Éû„É™
      - name: Export summary
        if: always()
        run: |
          echo "## üìä BigQuery Export Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Export Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${{ steps.export.outputs.duration }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.export.outcome == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **Table**: ${{ inputs.table || 'ÂÖ®„ÉÜ„Éº„Éñ„É´' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Dataset**: ${{ inputs.dataset || '„Éá„Éï„Ç©„É´„Éà' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Table**: ÂÖ®„ÉÜ„Éº„Éñ„É´Ôºà„Çπ„Ç±„Ç∏„É•„Éº„É´ÂÆüË°åÔºâ" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/export_output.txt ]; then
            echo "### Export Output (last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/export_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      # SlackÈÄöÁü•
      - name: Notify export status (Slack)
        if: always()
        continue-on-error: true
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ steps.export.outcome == 'success' && '‚úÖ' || '‚ùå' }} BigQuery Export ${{ steps.export.outcome }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.export.outcome == 'success' && '‚úÖ *BigQuery Export Successful*' || '‚ùå *BigQuery Export Failed*' }}\n*Trigger*: ${{ github.event_name }}\n*Duration*: ${{ steps.export.outputs.duration }}s\n*Workflow*: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
