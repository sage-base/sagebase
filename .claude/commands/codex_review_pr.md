---
allowed-tools: Read, Glob, Grep, Bash, AskUserQuestion, mcp__codex__codex, mcp__codex__codex-reply
description: PRをIssue・プランファイルと照合してCodexにレビューしてもらうコマンド
---
ultrathink
# Codex PRレビューワークフロー

PR番号: $ARGUMENTS

## 目的

PRの変更内容を、元のIssue（要件）と実装計画（planファイル）の両方と照合し、
Codex（OpenAI）に第三者視点でレビューしてもらいます。
「要件を満たしているか」「計画通りに実装されているか」「コード品質は十分か」を総合的に評価します。

---

## Phase 1: PR情報の取得

### 1.1 PR詳細の取得

!gh pr view $ARGUMENTS

### 1.2 PR差分の取得

!gh pr diff $ARGUMENTS

PR差分が大きすぎる場合（目安: 1000行以上）は、変更ファイル一覧と主要な変更箇所のサマリーに絞ってください。

---

## Phase 2: 関連Issue情報の取得

### 2.1 Issue番号の特定

PRの説明文から関連するIssue番号を特定してください。以下のパターンを探します：
- `Fixes #123` / `Closes #123` / `Resolves #123`
- `Issue #123` / `#123`
- PR本文中のIssueリンク

### 2.2 Issue情報の取得

Issue番号が特定できた場合：

!gh issue view {issue_number}

Issue番号が見つからない場合は、ユーザーにIssue番号を確認してください。
ユーザーがIssueなしと回答した場合は、Issueなしでレビューを進めてください。

---

## Phase 3: プランファイルの取得

### 3.1 プランファイルの検索

`tmp/` ディレクトリ内の `.md` ファイルを検索してください。

!ls tmp/*.md

### 3.2 ファイルの選択

- Issue番号に対応するプランファイル（`tmp/implementation_plan_{issue_number}.md`）がある場合: それを使用
- 該当ファイルがない場合: `tmp/` 内の他の `.md` ファイルをユーザーに提示して確認
- プランファイルがない場合: プランなしでレビューを進める（その旨をCodexに伝える）

### 3.3 プランの読み取り

見つかったプランファイルの全内容を読み取ってください。

---

## Phase 4: Codexへのレビュー依頼

### 4.1 レビュープロンプトの構築

以下の形式でCodexにレビューを依頼してください。
`mcp__codex__codex` ツールを使用し、`sandbox: read-only` で実行します。

**プロンプト構成**:

```
あなたはシニアソフトウェアエンジニアです。以下のPull Requestをレビューしてください。
Issue（要件）と実装計画（planファイル）が提供されている場合は、それらとの整合性も評価してください。

## レビュー観点

### 要件充足性（Issue vs PR）
- Issueの要件・受け入れ基準をPRが満たしているか
- 要件漏れや過剰実装がないか

### 計画整合性（Plan vs PR）
- 実装計画通りに実装されているか
- 計画からの逸脱がある場合、その理由は妥当か
- 計画で予定されていたが未実装の項目はないか

### コード品質
- コードの可読性・保守性
- エラーハンドリングは適切か
- テストカバレッジは十分か
- パフォーマンス上の懸念はないか

### アーキテクチャ整合性
- Clean Architectureの原則に反していないか
- 依存関係の方向は正しいか（Domain ← Application ← Infrastructure ← Interfaces）
- レイヤー間の境界は適切か

### 潜在的な問題
- バグの温床になりそうな箇所
- セキュリティ上の懸念
- 既存機能への影響（後方互換性）

## プロジェクトのコンテキスト

- Python + SQLAlchemy + PostgreSQL のWebアプリケーション
- Clean Architecture（Domain / Application / Infrastructure / Interfaces の4層）
- LLM統合にBAML（Boundary ML）を使用
- テストは pytest + pytest-asyncio、外部サービスは必ずモック
- リポジトリパターン: async/await + ISessionAdapter

## 元のIssue（要件）

{Issue情報がある場合はここに挿入。ない場合は「Issue情報なし」と記載}

## 実装計画

{プランファイルの内容がある場合はここに挿入。ない場合は「実装計画なし」と記載}

## Pull Request情報

### PR概要
{gh pr viewの出力をここに挿入}

### 変更差分
{gh pr diffの出力をここに挿入。大きすぎる場合は要約}

## 回答形式

以下の形式でレビュー結果を日本語で返してください：

### 総合評価
[Approve / Request Changes / Comment]
一言サマリー

### 要件充足性
- Issueの要件に対するカバレッジ評価
- 漏れている要件があれば指摘

### 計画との整合性
- 実装計画との差異
- 差異がある場合の妥当性評価

### コード品質
- 良い点
- 改善すべき点（具体的なファイル・行を示す）

### 指摘事項
各指摘に以下のラベルを付与：
- [must] マージ前に修正必須
- [should] 修正を推奨
- [nit] 些細な改善提案
- [question] 確認したい点

### 見落としリスク
- 潜在的なバグやリグレッション
- テストで検証されていない重要なケース
```

### 4.2 Codex呼び出しパラメータ

```
mcp__codex__codex:
  prompt: {上記のプロンプト}
  sandbox: read-only
  approval-policy: on-failure
```

**重要**: Codexにはコードの読み取り権限を与えてください（`read-only`）。
Codexがコードベースを実際に参照することで、変更の影響範囲をより正確に判断できます。

---

## Phase 5: レビュー結果の提示

### 5.1 フィードバックの整理

Codexから返されたレビュー結果をユーザーにそのまま提示してください。

### 5.2 アクション提案

レビュー結果を基に、以下のアクションをユーザーに提案してください：

1. **Approve評価の場合**: マージを提案
2. **Request Changes評価の場合**: 指摘事項の修正を提案、[must]の修正を優先
3. **Comment評価の場合**: 指摘事項の検討を提案

### 5.3 追加レビューの確認

フィードバックに対してユーザーが質問やフォローアップを希望する場合は、
`mcp__codex__codex-reply` を使用してCodexとの対話を継続してください。

---

## 注意事項

- このコマンドは**レビューのみ**を行います。コードの修正は行いません
- Codexのフィードバックはあくまで参考意見です。最終判断はユーザーが行います
- PR差分が非常に大きい場合は、主要な変更に焦点を絞ってレビューを依頼してください
- Codexとの対話が長くなる場合は、要点をまとめてユーザーに提示してください
