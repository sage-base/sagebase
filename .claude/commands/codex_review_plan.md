---
allowed-tools: Read, Glob, Grep, Bash, AskUserQuestion, mcp__codex__codex, mcp__codex__codex-reply
description: 作成した実装計画をCodexにレビューしてもらうコマンド
---
ultrathink
# Codex プランレビューワークフロー

引数（オプション）: $ARGUMENTS

## 目的

`tmp/` 配下にある実装計画ファイルをCodex（OpenAI）に送信し、第三者視点でのレビューフィードバックを取得します。
Claude Codeが作成した計画のバイアスを排除し、品質を向上させることが目的です。

---

## Phase 1: プランファイルの特定と読み取り

### 1.1 プランファイルの検索

`tmp/` ディレクトリ内の `.md` ファイルを検索してください。

!ls tmp/*.md

### 1.2 ファイルの選択

- ファイルが1つだけの場合: そのファイルを使用
- ファイルが複数ある場合: ユーザーにどのファイルをレビューするか確認
- ファイルが見つからない場合: ユーザーに「先に `/plan_issue` でプランを作成してください」と案内して終了

### 1.3 プランの読み取り

選択されたプランファイルの全内容を読み取ってください。

---

## Phase 2: Issue情報の取得

Issue情報を取得してレビューのコンテキストを補完します。
以下の優先順位でIssue番号を決定してください：

1. **$ARGUMENTS が指定されている場合**: その番号をIssue番号として使用
2. **プランファイル内にIssue番号（`#数字` や `Issue #数字` 形式）が記載されている場合**: その番号を使用
3. **上記いずれも該当しない場合**: Issue情報なしでレビューを実行（このフェーズをスキップ）

Issue番号が特定できた場合：

!gh issue view {issue_number}

取得したIssue情報は、Codexへのレビュー依頼に含めてください。
Issueの要件に対してプランが十分かどうかもレビュー観点に含まれます。

---

## Phase 3: Codexへのレビュー依頼

### 3.1 レビュープロンプトの構築

以下の形式でCodexにレビューを依頼してください。
`mcp__codex__codex` ツールを使用し、`sandbox: read-only` で実行します。

**プロンプト構成**:

```
あなたはシニアソフトウェアエンジニアです。以下の実装計画をレビューしてください。

## レビュー観点

1. **要件充足性**: Issueの要件・受け入れ基準を計画が十分にカバーしているか
2. **完全性**: 実装に必要なステップが漏れていないか
3. **技術的正確性**: 技術的な判断に誤りがないか
4. **リスク**: 見落とされているリスクや副作用はないか
5. **アーキテクチャ整合性**: Clean Architectureの原則に反していないか
6. **テスト計画**: テストカバレッジは十分か
7. **実装順序**: タスクの依存関係と順序は適切か

## プロジェクトのコンテキスト

- Python + SQLAlchemy + PostgreSQL のWebアプリケーション
- Clean Architecture（Domain / Application / Infrastructure / Interfaces の4層）
- LLM統合にBAML（Boundary ML）を使用
- テストは pytest + pytest-asyncio、外部サービスは必ずモック

## 元のIssue（要件）

{Issue情報がある場合はここに挿入。ない場合は「Issue情報なし」と記載}

## レビュー対象の実装計画

{プランファイルの全内容をここに挿入}

## 回答形式

以下の形式でレビュー結果を日本語で返してください：

### 総合評価
[Good / Needs Improvement / Major Concerns]

### 要件カバレッジ
- Issueの要件に対して計画がカバーしている範囲の評価
- 漏れている要件があれば指摘

### 良い点
- ...

### 改善提案
- [優先度: 高/中/低] 提案内容

### 見落としリスク
- ...

### 追加で検討すべきこと
- ...
```

### 3.2 Codex呼び出しパラメータ

```
mcp__codex__codex:
  prompt: {上記のプロンプト}
  sandbox: read-only
  approval-policy: on-failure
```

**重要**: Codexにはコードの読み取り権限を与えてください（`read-only`）。
Codexがコードベースを実際に参照することで、プランの実現可能性をより正確に判断できます。

---

## Phase 4: レビュー結果の提示

### 4.1 フィードバックの整理

Codexから返されたレビュー結果をユーザーにそのまま提示してください。

### 4.2 アクション提案

レビュー結果を基に、以下のアクションをユーザーに提案してください：

1. **改善提案がある場合**: プランファイルの修正を提案
2. **問題がない場合**: `/solve_issue` での実装開始を提案
3. **大きな懸念がある場合**: 計画の見直しを提案

### 4.3 追加レビューの確認

フィードバックに対してユーザーが質問やフォローアップを希望する場合は、
`mcp__codex__codex-reply` を使用してCodexとの対話を継続してください。

---

## 注意事項

- このコマンドは**レビューのみ**を行います。プランファイルの編集は行いません
- Codexのフィードバックはあくまで参考意見です。最終判断はユーザーが行います
- Codexとの対話が長くなる場合は、要点をまとめてユーザーに提示してください
