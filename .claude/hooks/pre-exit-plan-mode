#!/bin/bash

# Pre-ExitPlanMode hook - Codex CLIã§planãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã‹ã‚‰plan modeã‚’çµ‚äº†ã™ã‚‹
#
# å‹•ä½œ:
# 1. tmp/ é…ä¸‹ã®æœ€æ–° .md ãƒ•ã‚¡ã‚¤ãƒ«ã‚’planãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ¤œå‡º
# 2. Codex CLI (codex exec) ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
# 3. ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ additionalContext ã¨ã—ã¦ Claude ã«è¿”ã™
# 4. ExitPlanMode ã¯ allowï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯å‚è€ƒæƒ…å ±ã¨ã—ã¦æä¾›ï¼‰

set -euo pipefail

# stdin ã‹ã‚‰ JSON ã‚’èª­ã¿å–ã‚‹
json_input=$(cat)

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ç‰¹å®š
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$(dirname "$0")/../.." && pwd)}"

# tmp/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
if [ ! -d "$PROJECT_ROOT/tmp" ]; then
    python3 -c '
import json, sys
json.dump({
    "hookSpecificOutput": {
        "hookEventName": "PreToolUse",
        "additionalContext": "âš ï¸ tmp/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚planãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚"
    }
}, sys.stdout)
'
    exit 0
fi

# tmp/ é…ä¸‹ã®æœ€æ–° .md ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
PLAN_FILE=$(ls -t "$PROJECT_ROOT/tmp/"*.md 2>/dev/null | head -1 || true)

if [ -z "$PLAN_FILE" ]; then
    python3 -c '
import json, sys
json.dump({
    "hookSpecificOutput": {
        "hookEventName": "PreToolUse",
        "additionalContext": "âš ï¸ tmp/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«planãƒ•ã‚¡ã‚¤ãƒ«(.md)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Codexãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
    }
}, sys.stdout)
'
    exit 0
fi

PLAN_FILENAME=$(basename "$PLAN_FILE")

# Codex CLI ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ã—ã¦ stdin çµŒç”±ã§æ¸¡ã™
CODEX_REVIEW=$(
{
    cat <<'PROMPT_HEADER'
ä»¥ä¸‹ã®å®Ÿè£…è¨ˆç”»ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
å•é¡Œç‚¹ã€æ”¹å–„ææ¡ˆã€ãƒªã‚¹ã‚¯ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
1. å®Ÿè£…æ‰‹é †ã®å¦¥å½“æ€§ã¨å®Œå…¨æ€§
2. æŠ€è¡“çš„ãƒªã‚¹ã‚¯ã‚„è€ƒæ…®æ¼ã‚Œ
3. æ—¢å­˜ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã®æ•´åˆæ€§
4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ååˆ†æ€§

ç°¡æ½”ã«ç®‡æ¡æ›¸ãã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
å•é¡ŒãŒãªã‘ã‚Œã°ã€Œå•é¡Œãªã—ã€ã¨æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚

---
å®Ÿè£…è¨ˆç”»:
PROMPT_HEADER
    cat "$PLAN_FILE"
} | codex exec - 2>&1
) || true

CODEX_EXIT=${PIPESTATUS[0]:-$?}

# Python ã§ JSON ã‚’å®‰å…¨ã«ç”Ÿæˆã—ã¦å‡ºåŠ›
export PLAN_FILENAME
export CODEX_REVIEW
export CODEX_EXIT

python3 -c '
import json, sys, os

plan_filename = os.environ.get("PLAN_FILENAME", "unknown")
codex_review = os.environ.get("CODEX_REVIEW", "")
codex_exit = int(os.environ.get("CODEX_EXIT", "1"))

if codex_exit != 0 or not codex_review.strip():
    context = (
        f"âš ï¸ Codexãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ (exit: {codex_exit})\n\n"
        f"planãƒ•ã‚¡ã‚¤ãƒ«: {plan_filename}\n\n"
        f"Codexå‡ºåŠ›:\n{codex_review}\n\n"
        "Codexãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã—ã§plan modeã‚’çµ‚äº†ã—ã¾ã™ã€‚"
    )
else:
    context = (
        f"## ğŸ“‹ Codex Plan Review\n\n"
        f"planãƒ•ã‚¡ã‚¤ãƒ«: {plan_filename}\n\n"
        f"### ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n"
        f"{codex_review}\n\n"
        "---\n"
        "ä¸Šè¨˜ã¯Codex CLIã«ã‚ˆã‚‹planãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã§ã™ã€‚"
    )

output = {
    "hookSpecificOutput": {
        "hookEventName": "PreToolUse",
        "additionalContext": context
    }
}
json.dump(output, sys.stdout)
'

exit 0
